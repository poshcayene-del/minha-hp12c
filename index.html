<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>HP-12C Web – Corrigida</title>

<style>
body{
  background:#1b1b1b;
  font-family:Arial, Helvetica, sans-serif;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
.calc{
  background:#3a2f1f;
  padding:18px;
  border-radius:12px;
  width:330px;
  box-shadow:0 0 25px #000;
}
.display{
  background:#c9d1b8;
  font-family:"Courier New", monospace;
  font-size:26px;
  padding:12px;
  text-align:right;
  border-radius:6px;
  margin-bottom:10px;
}
.keys{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:6px;
}
button{
  padding:12px 6px;
  font-size:13px;
  border:none;
  border-radius:6px;
  background:#2b2b2b;
  color:#fff;
  cursor:pointer;
}
button.yellow{background:#d4a017;color:#000;}
button.blue{background:#1e3a5f;}
button.gray{background:#555;}
button:active{transform:scale(0.97);}
</style>
</head>

<body>

<div class="calc">
  <div id="display" class="display">0.00</div>

  <div class="keys">
    <button class="yellow">f</button>
    <button class="blue">g</button>
    <button onclick="chs()">CHS</button>
    <button onclick="clx()">CLX</button>
    <button onclick="clearAll()">CLR</button>

    <button onclick="num(7)">7</button>
    <button onclick="num(8)">8</button>
    <button onclick="num(9)">9</button>
    <button onclick="store('n')">n</button>
    <button onclick="store('i')">i</button>

    <button onclick="num(4)">4</button>
    <button onclick="num(5)">5</button>
    <button onclick="num(6)">6</button>
    <button onclick="store('pv')">PV</button>
    <button onclick="store('pmt')">PMT</button>

    <button onclick="num(1)">1</button>
    <button onclick="num(2)">2</button>
    <button onclick="num(3)">3</button>
    <button onclick="store('fv')">FV</button>
    <button onclick="calcIRR()">IRR</button>

    <button onclick="num(0)">0</button>
    <button onclick="dot()">.</button>
    <button class="gray" onclick="enter()">ENTER</button>
    <button onclick="calcNPV()">NPV</button>
    <button onclick="addCF()">CFj</button>
  </div>
</div>

<script>
let display=document.getElementById("display");

// ---------- RPN ----------
let stack=[0,0,0,0];
let buffer="";
let typing=false;

// ---------- TVM ----------
let tvm={n:null,i:null,pv:null,pmt:null,fv:null};

// ---------- CASH FLOW ----------
let CF0=null;
let CF=[];

// ---------- DISPLAY ----------
function refresh(){
  display.innerText=stack[0].toFixed(2);
}

// ---------- INPUT ----------
function num(n){
  buffer+=n;
  typing=true;
  display.innerText=buffer;
}
function dot(){
  if(!buffer.includes(".")) buffer+=".";
  display.innerText=buffer;
}
function enter(){
  let v=typing?parseFloat(buffer):stack[0];
  stack=[v,stack[0],stack[1],stack[2]];
  buffer=""; typing=false;
  refresh();
}

// ---------- BASIC ----------
function chs(){stack[0]*=-1;refresh();}
function clx(){stack[0]=0;refresh();}
function clearAll(){
  stack=[0,0,0,0];
  buffer=""; typing=false;
  tvm={n:null,i:null,pv:null,pmt:null,fv:null};
  CF0=null; CF=[];
  refresh();
}

// ---------- TVM ----------
function store(k){
  if(typing) enter();
  tvm[k]=stack[0];

  let {n,i,pv,pmt,fv}=tvm;
  if(n==null||i==null) return;

  let r=i/100;
  let f=Math.pow(1+r,n);

  if(k==="fv" && pv!=null && pmt!=null){
    stack[0]=-(pv*f + pmt*(f-1)/r);
  }
  if(k==="pv" && fv!=null && pmt!=null){
    stack[0]=-(fv + pmt*(f-1)/r)/f;
  }
  if(k==="pmt" && pv!=null && fv!=null){
    stack[0]=-(pv*r)/(1-Math.pow(1+r,-n));
  }
  refresh();
}

// ---------- CASH FLOW ----------
function addCF(){
  if(typing) enter();
  if(CF0===null) CF0=stack[0];
  else CF.push(stack[0]);
}

function calcNPV(){
  if(CF0===null||CF.length===0) return;
  let r=tvm.i/100;
  let npv=CF0;
  for(let t=0;t<CF.length;t++){
    npv+=CF[t]/Math.pow(1+r,t+1);
  }
  stack[0]=npv;
  refresh();
}

function calcIRR(){
  if(CF0===null||CF.length===0) return;

  // valida alternância de sinal
  let hasPos=false, hasNeg=false;
  [CF0,...CF].forEach(v=>{
    if(v>0) hasPos=true;
    if(v<0) hasNeg=true;
  });
  if(!(hasPos&&hasNeg)){
    stack[0]=0;
    refresh();
    return;
  }

  let rate=0.1;
  for(let i=0;i<100;i++){
    let npv=CF0, dnpv=0;
    for(let t=0;t<CF.length;t++){
      let df=Math.pow(1+rate,t+1);
      npv+=CF[t]/df;
      dnpv+=-(t+1)*CF[t]/(df*(1+rate));
    }
    if(Math.abs(dnpv)<1e-10) break;
    rate-=npv/dnpv;
  }
  stack[0]=rate*100;
  refresh();
}
</script>

</body>
</html>
