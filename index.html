<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HP 12c Ultimate Professional</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --bg: #121212;
            --case: #2a2a2a;
            --brushed-metal: linear-gradient(180deg, #555 0%, #333 10%, #444 50%, #222 100%);
            --lcd-bg: #9ead94;
            --btn-black: linear-gradient(180deg, #222 0%, #111 100%);
            --btn-orange: #ff9500;
            --btn-blue: #007aff;
        }

        body { background: var(--bg); display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden; }
        
        .hp12c {
            background: var(--case); width: 95vw; max-width: 640px;
            padding: 45px 15px 35px 15px; border-radius: 15px;
            box-shadow: inset 1px 1px 3px rgba(255,255,255,0.1), 0 30px 60px rgba(0,0,0,1);
            border: 1px solid #000; position: relative;
        }

        .hp12c::before {
            content: "12C PLATINUM"; position: absolute; top: 12px; right: 30px; 
            color: #aaa; font-size: 10px; font-weight: bold; letter-spacing: 1px;
        }

        .lcd {
            position: relative; z-index: 1; background: var(--lcd-bg); height: 85px;
            border-radius: 4px; 
            margin-bottom: 50px; /* Aumentado para não cortar os rótulos da 1ª fileira */
            display: flex; flex-direction: column;
            align-items: flex-end; justify-content: center; padding: 0 15px;
            font-family: 'Courier New', monospace; border: 6px solid #111;
            box-shadow: inset 0 8px 20px rgba(0,0,0,0.5);
        }

        #prefix-display { font-size: 11px; height: 14px; color: #333; width: 100%; text-align: left; font-weight: bold; }
        #main-display { font-size: 40px; color: #1a1d18; font-weight: bold; letter-spacing: -1px; }

        .keypad { 
            display: grid; 
            grid-template-columns: repeat(10, 1fr); 
            gap: 28px 8px; /* Espaço vertical bem amplo para evitar qualquer corte */
            position: relative; 
            z-index: 1;
            padding-top: 10px; /* Espaço extra para a primeira linha de rótulos */
        }

        .btn {
            height: 46px; border: 1px solid #000; border-radius: 4px; color: white;
            font-size: 11px; font-weight: bold; cursor: pointer; background: var(--btn-black);
            box-shadow: inset 0 1px 1px rgba(255,255,255,0.1), 0 3px 0 #000; 
            position: relative;
            display: flex; align-items: center; justify-content: center;
        }

        .btn:active { transform: translateY(2px); box-shadow: 0 1px 0 #000; }
        .btn-f { background: var(--btn-orange); color: #000; }
        .btn-g { background: var(--btn-blue); color: #fff; }
        .btn-enter { grid-row: span 2; height: 120px; background: #444; }

        .f-label { 
            color: var(--btn-orange); position: absolute; top: -20px; 
            width: 100%; left: 0; font-size: 8px; text-align: center; 
            white-space: nowrap; font-weight: normal;
        }
        .g-label { 
            color: var(--btn-blue); position: absolute; bottom: -20px; 
            width: 100%; left: 0; font-size: 8px; text-align: center; 
            white-space: nowrap; font-weight: normal;
        }
    </style>
</head>
<body>
<div class="hp12c">
    <div class="lcd">
        <div id="prefix-display"></div>
        <div id="main-display">0.00</div>
    </div>
    <div class="keypad">
        <button class="btn" onclick="handleFin('n')"><span class="f-label">AMORT</span>n<span class="g-label">12x</span></button>
        <button class="btn" onclick="handleFin('i')"><span class="f-label">INT</span>i<span class="g-label">12÷</span></button>
        <button class="btn" onclick="handleFin('pv')"><span class="f-label">NPV</span>PV<span class="g-label">CFo</span></button>
        <button class="btn" onclick="handleFin('pmt')"><span class="f-label">IRR</span>PMT<span class="g-label">CFj</span></button>
        <button class="btn" onclick="handleFin('fv')"><span class="f-label"></span>FV<span class="g-label">Nj</span></button>
        <button class="btn" onclick="toggleSign()">CHS<span class="f-label">DATE</span><span class="g-label">BEG</span></button>
        <button class="btn" onclick="pressNum(7)">7</button>
        <button class="btn" onclick="pressNum(8)">8</button>
        <button class="btn" onclick="pressNum(9)">9</button>
        <button class="btn" onclick="execOp('/')">÷</button>

        <button class="btn" onclick="execOp('pow')">y<sup>x</sup><span class="g-label">√x</span></button>
        <button class="btn" onclick="execOp('1/x')">1/x<span class="g-label">LN</span></button>
        <button class="btn" onclick="execOp('%')">%</button>
        <button class="btn" onclick="handleDate()">Δ%<span class="g-label">ΔDYS</span></button>
        <button class="btn" onclick="handleStats()">Σ+<span class="g-label">Σ-</span></button>
        <button class="btn" onclick="handleClear()">CLX<span class="f-label">REG</span><span class="g-label">FIN</span></button>
        <button class="btn" onclick="pressNum(4)">4</button>
        <button class="btn" onclick="pressNum(5)">5</button>
        <button class="btn" onclick="pressNum(6)">6</button>
        <button class="btn" onclick="execOp('*')">×</button>

        <button class="btn btn-f" onclick="setPrefix('f')">f</button>
        <button class="btn btn-g" onclick="setPrefix('g')">g</button>
        <button class="btn" onclick="setPrefix('sto')">STO</button>
        <button class="btn" onclick="setPrefix('rcl')">RCL</button>
        <button class="btn btn-enter" onclick="pressEnter()">ENTER</button>
        <button class="btn" onclick="pressNum(1)">1</button>
        <button class="btn" onclick="pressNum(2)">2</button>
        <button class="btn" onclick="pressNum(3)">3</button>
        <button class="btn" onclick="execOp('-')">-</button>

        <button class="btn">ON</button>
        <button class="btn" style="grid-column: span 2;" onclick="pressNum(0)">0</button>
        <button class="btn" onclick="pressDot()">.</button>
        <button class="btn" onclick="execOp('+')">+</button>
    </div>
</div>

<script>
    let stack = [0, 0, 0, 0];
    let fin = { n: 0, i: 0, pv: 0, pmt: 0, fv: 0 };
    let registers = new Array(20).fill(0);
    let cashFlows = [];
    let displayValue = "0";
    let isNewInput = true;
    let prefix = null;
    let decimals = 2;

    const mainDisp = document.getElementById('main-display');
    const prefDisp = document.getElementById('prefix-display');

    function updateLCD(val = stack[0]) {
        mainDisp.innerText = isNaN(val) ? "Error 5" : parseFloat(val).toLocaleString('en-US', {minimumFractionDigits: decimals, maximumFractionDigits: decimals});
        prefix = null; prefDisp.innerText = "";
    }

    function setPrefix(p) { prefix = p; prefDisp.innerText = p.toUpperCase(); }

    function pressNum(n) {
        if (prefix === 'f' && !isNaN(n)) { decimals = n; updateLCD(); return; }
        if (prefix === 'sto') { registers[n] = stack[0]; updateLCD(); return; }
        if (prefix === 'rcl') { stack[0] = registers[n]; updateLCD(); return; }
        
        if (isNewInput) { displayValue = n.toString(); isNewInput = false; }
        else { displayValue += n.toString(); }
        stack[0] = parseFloat(displayValue);
        mainDisp.innerText = displayValue;
    }

    function pressEnter() {
        stack[3] = stack[2]; stack[2] = stack[1]; stack[1] = stack[0];
        isNewInput = true; updateLCD();
    }

    function handleFin(key) {
        if (prefix === 'g') {
            if (key === 'pv') { cashFlows = [stack[0]]; blink(); }
            else if (key === 'pmt') { cashFlows.push(stack[0]); blink(); }
            else if (key === 'n') { stack[0] *= 12; updateLCD(); }
            else if (key === 'i') { stack[0] /= 12; updateLCD(); }
        } else if (prefix === 'f') {
            if (key === 'pv') calculateNPV();
            else if (key === 'pmt') calculateIRR();
            else solveTVM(key);
        } else {
            fin[key] = stack[0]; isNewInput = true; blink();
        }
    }

    function solveTVM(target) {
        let n = fin.n, i = fin.i/100, pv = fin.pv, pmt = fin.pmt, fv = fin.fv;
        let res = 0;
        try {
            if (target === 'fv') res = -(pv * Math.pow(1+i, n) + pmt * (Math.pow(1+i, n) - 1) / i);
            if (target === 'pv') res = -(fv / Math.pow(1+i, n) + pmt * (1 - Math.pow(1+i, -n)) / i);
            if (target === 'pmt') res = -(pv * Math.pow(1+i, n) + fv) / ((Math.pow(1+i, n) - 1) / i);
            if (target === 'n') res = Math.log((pmt - fv*i)/(pmt + pv*i)) / Math.log(1+i);
            if (target === 'i') res = calculateRate(n, pmt, pv, fv) * 100;
            stack[0] = res;
        } catch(e) { stack[0] = NaN; }
        updateLCD();
    }

    function calculateRate(n, pmt, pv, fv) {
        let i = 0.01;
        for (let j = 0; j < 100; j++) {
            let t1 = Math.pow(1+i, n);
            let f = pv * t1 + pmt * (t1 - 1) / i + fv;
            let df = n * pv * Math.pow(1+i, n-1) + pmt * (n*i*Math.pow(1+i, n-1) - t1 + 1) / (i*i);
            i = i - f / df;
        }
        return i;
    }

    function calculateNPV() {
        let i = fin.i / 100;
        stack[0] = cashFlows.reduce((acc, val, idx) => acc + val / Math.pow(1 + i, idx), 0);
        updateLCD();
    }

    function calculateIRR() {
        let irr = 0.1;
        for (let i = 0; i < 100; i++) {
            let npv = 0, dnpv = 0;
            cashFlows.forEach((val, j) => {
                npv += val / Math.pow(1 + irr, j);
                dnpv -= j * val / Math.pow(1 + irr, j + 1);
            });
            irr -= npv / dnpv;
        }
        stack[0] = irr * 100; updateLCD();
    }

    function handleClear() {
        if (prefix === 'f') { fin={n:0,i:0,pv:0,pmt:0,fv:0}; cashFlows=[]; registers.fill(0); }
        stack[0] = 0; isNewInput = true; updateLCD();
    }

    function execOp(op) {
        let x = stack[0], y = stack[1];
        if (op === '+') stack[0] = y + x;
        if (op === '-') stack[0] = y - x;
        if (op === '*') stack[0] = y * x;
        if (op === '/') stack[0] = x !== 0 ? y / x : 0;
        if (op === 'pow') stack[0] = Math.pow(y, x);
        stack[1] = stack[2]; stack[2] = stack[3];
        isNewInput = true; updateLCD();
    }

    function toggleSign() { stack[0] *= -1; displayValue = stack[0].toString(); updateLCD(); }
    function pressDot() { if (!displayValue.includes('.')) displayValue += '.'; mainDisp.innerText = displayValue; }
    function blink() { mainDisp.style.opacity = "0.3"; setTimeout(() => mainDisp.style.opacity = "1", 100); }

    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
</script>
</body>
</html>
