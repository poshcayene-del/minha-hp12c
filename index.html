<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HP 12c Ultimate</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --bg: #121212;
            --case: #2a2a2a;
            --lcd-bg: #9ead94;
            --btn-black: linear-gradient(180deg, #333 0%, #111 100%);
            --btn-orange: #ff9500;
            --btn-blue: #007aff;
        }

        body { 
            background: var(--bg); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            font-family: 'Arial', sans-serif; 
        }
        
        .hp12c {
            background: var(--case); 
            width: 98vw; 
            max-width: 500px; /* Reduzi um pouco a largura máxima para dar mais margem */
            padding: 40px 10px; 
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            border: 1px solid #000;
            display: flex;
            flex-direction: column;
        }

        .lcd {
            background: var(--lcd-bg); 
            height: 60px; 
            border-radius: 4px; 
            margin: 0 10px 45px 10px; /* Margem inferior grande para o rótulo da 1ª fila */
            display: flex; 
            flex-direction: column;
            align-items: flex-end; 
            justify-content: center; 
            padding: 0 15px;
            font-family: 'monospace'; 
            border: 4px solid #111;
            box-shadow: inset 0 4px 10px rgba(0,0,0,0.3);
        }

        #prefix-display { font-size: 10px; height: 12px; color: #333; width: 100%; text-align: left; }
        #main-display { font-size: 32px; color: #1a1d18; font-weight: bold; }

        .keypad { 
            display: grid; 
            grid-template-columns: repeat(10, 1fr); 
            gap: 26px 4px; /* Aumentei o espaço vertical e diminuí o horizontal */
            padding: 0 5px;
        }

        .btn {
            height: 38px; /* Botões levemente mais baixos para ganhar espaço */
            border: 1px solid #000; 
            border-radius: 3px; 
            color: white;
            font-size: 10px; 
            font-weight: bold; 
            cursor: pointer; 
            background: var(--btn-black);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 0 #000;
        }

        .btn:active { transform: translateY(1px); box-shadow: none; }
        .btn-f { background: var(--btn-orange); color: #000; }
        .btn-g { background: var(--btn-blue); color: #fff; }
        .btn-enter { grid-row: span 2; height: calc(76px + 26px); }

        /* Rótulos com posicionamento revisado */
        .f-label { 
            color: var(--btn-orange); 
            position: absolute; 
            top: -18px; 
            width: 100%; 
            font-size: 7px; 
            text-align: center;
            font-weight: normal;
        }
        .g-label { 
            color: var(--btn-blue); 
            position: absolute; 
            bottom: -18px; 
            width: 100%; 
            font-size: 7px; 
            text-align: center;
            font-weight: normal;
        }
    </style>
</head>
<body>

<div class="hp12c">
    <div class="lcd">
        <div id="prefix-display"></div>
        <div id="main-display">0.00</div>
    </div>
    <div class="keypad">
        <button class="btn" onclick="handleFin('n')"><span class="f-label">AMORT</span>n<span class="g-label">12x</span></button>
        <button class="btn" onclick="handleFin('i')"><span class="f-label">INT</span>i<span class="g-label">12÷</span></button>
        <button class="btn" onclick="handleFin('pv')"><span class="f-label">NPV</span>PV<span class="g-label">CFo</span></button>
        <button class="btn" onclick="handleFin('pmt')"><span class="f-label">IRR</span>PMT<span class="g-label">CFj</span></button>
        <button class="btn" onclick="handleFin('fv')"><span class="f-label"></span>FV<span class="g-label">Nj</span></button>
        <button class="btn" onclick="toggleSign()">CHS<span class="f-label">DATE</span><span class="g-label">BEG</span></button>
        <button class="btn" onclick="pressNum(7)">7</button>
        <button class="btn" onclick="pressNum(8)">8</button>
        <button class="btn" onclick="pressNum(9)">9</button>
        <button class="btn" onclick="execOp('/')">÷</button>

        <button class="btn" onclick="execOp('pow')">y<sup>x</sup><span class="g-label">√x</span></button>
        <button class="btn" onclick="execOp('1/x')">1/x<span class="g-label">LN</span></button>
        <button class="btn" onclick="execOp('%')">%</button>
        <button class="btn" onclick="handleDate()">Δ%<span class="g-label">ΔDYS</span></button>
        <button class="btn" onclick="handleStats()">Σ+<span class="g-label">Σ-</span></button>
        <button class="btn" onclick="handleClear()">CLX<span class="f-label">REG</span><span class="g-label">FIN</span></button>
        <button class="btn" onclick="pressNum(4)">4</button>
        <button class="btn" onclick="pressNum(5)">5</button>
        <button class="btn" onclick="pressNum(6)">6</button>
        <button class="btn" onclick="execOp('*')">×</button>

        <button class="btn btn-f" onclick="setPrefix('f')">f</button>
        <button class="btn btn-g" onclick="setPrefix('g')">g</button>
        <button class="btn" onclick="setPrefix('sto')">STO</button>
        <button class="btn" onclick="setPrefix('rcl')">RCL</button>
        <button class="btn btn-enter" onclick="pressEnter()">ENTER</button>
        <button class="btn" onclick="pressNum(1)">1</button>
        <button class="btn" onclick="pressNum(2)">2</button>
        <button class="btn" onclick="pressNum(3)">3</button>
        <button class="btn" onclick="execOp('-')">-</button>

        <button class="btn">ON</button>
        <button class="btn" style="grid-column: span 2;" onclick="pressNum(0)">0</button>
        <button class="btn" onclick="pressDot()">.</button>
        <button class="btn" onclick="execOp('+')">+</button>
    </div>
</div>

<script>
    /* O Script permanece exatamente o mesmo, pois a lógica de cálculo não mudou */
    let stack = [0, 0, 0, 0];
    let fin = { n: 0, i: 0, pv: 0, pmt: 0, fv: 0 };
    let registers = new Array(20).fill(0);
    let cashFlows = [];
    let displayValue = "0";
    let isNewInput = true;
    let prefix = null;
    let decimals = 2;

    const mainDisp = document.getElementById('main-display');
    const prefDisp = document.getElementById('prefix-display');

    function updateLCD(val = stack[0]) {
        mainDisp.innerText = isNaN(val) ? "Error 5" : parseFloat(val).toLocaleString('en-US', {minimumFractionDigits: decimals, maximumFractionDigits: decimals});
        prefix = null; prefDisp.innerText = "";
    }

    function setPrefix(p) { prefix = p; prefDisp.innerText = p.toUpperCase(); }

    function pressNum(n) {
        if (prefix === 'f' && !isNaN(n)) { decimals = n; updateLCD(); return; }
        if (prefix === 'sto') { registers[n] = stack[0]; updateLCD(); return; }
        if (prefix === 'rcl') { stack[0] = registers[n]; updateLCD(); return; }
        if (isNewInput) { displayValue = n.toString(); isNewInput = false; }
        else { displayValue += n.toString(); }
        stack[0] = parseFloat(displayValue);
        mainDisp.innerText = displayValue;
    }

    function pressEnter() {
        stack[3] = stack[2]; stack[2] = stack[1]; stack[1] = stack[0];
        isNewInput = true; updateLCD();
    }

    function handleFin(key) {
        if (prefix === 'g') {
            if (key === 'pv') { cashFlows = [stack[0]]; blink(); }
            else if (key === 'pmt') { cashFlows.push(stack[0]); blink(); }
            else if (key === 'n') { stack[0] *= 12; updateLCD(); }
            else if (key === 'i') { stack[0] /= 12; updateLCD(); }
        } else if (prefix === 'f') {
            if (key === 'pv') calculateNPV();
            else if (key === 'pmt') calculateIRR();
            else solveTVM(key);
        } else {
            fin[key] = stack[0]; isNewInput = true; blink();
        }
    }

    function solveTVM(target) {
        let n = fin.n, i = fin.i/100, pv = fin.pv, pmt = fin.pmt, fv = fin.fv;
        let res = 0;
        try {
            if (target === 'fv') res = -(pv * Math.pow(1+i, n) + pmt * (Math.pow(1+i, n) - 1) / i);
            if (target === 'pv') res = -(fv / Math.pow(1+i, n) + pmt * (1 - Math.pow(1+i, -n)) / i);
            if (target === 'pmt') res = -(pv * Math.pow(1+i, n) + fv) / ((Math.pow(1+i, n) - 1) / i);
            if (target === 'n') res = Math.log((pmt - fv*i)/(pmt + pv*i)) / Math.log(1+i);
            stack[0] = res;
        } catch(e) { stack[0] = NaN; }
        updateLCD();
    }

    function calculateNPV() {
        let i = fin.i / 100;
        stack[0] = cashFlows.reduce((acc, val, idx) => acc + val / Math.pow(1 + i, idx), 0);
        updateLCD();
    }

    function calculateIRR() {
        let irr = 0.1;
        for (let i = 0; i < 100; i++) {
            let npv = 0, dnpv = 0;
            cashFlows.forEach((val, j) => {
                npv += val / Math.pow(1 + irr, j);
                dnpv -= j * val / Math.pow(1 + irr, j + 1);
            });
            irr -= npv / dnpv;
        }
        stack[0] = irr * 100; updateLCD();
    }

    function handleClear() {
        if (prefix === 'f') { fin={n:0,i:0,pv:0,pmt:0,fv:0}; cashFlows=[]; registers.fill(0); }
        stack[0] = 0; isNewInput = true; updateLCD();
    }

    function execOp(op) {
        let x = stack[0], y = stack[1];
        if (op === '+') stack[0] = y + x;
        if (op === '-') stack[0] = y - x;
        if (op === '*') stack[0] = y * x;
        if (op === '/') stack[0] = x !== 0 ? y / x : 0;
        if (op === 'pow') stack[0] = Math.pow(y, x);
        stack[1] = stack[2]; stack[2] = stack[3];
        isNewInput = true; updateLCD();
    }

    function toggleSign() { stack[0] *= -1; displayValue = stack[0].toString(); updateLCD(); }
    function pressDot() { if (!displayValue.includes('.')) displayValue += '.'; mainDisp.innerText = displayValue; }
    function blink() { mainDisp.style.opacity = "0.3"; setTimeout(() => mainDisp.style.opacity = "1", 100); }

    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
</script>
</body>
</html>
